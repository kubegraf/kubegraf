name: iOS Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  build-ios:
    runs-on: macos-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: ui/solid/package-lock.json

      - name: Install dependencies
        run: |
          cd ui/solid
          npm ci

      - name: Build SolidJS UI
        run: |
          cd ui/solid
          npm run build

      - name: Install Capacitor CLI
        run: |
          cd ui/solid
          npm install -g @capacitor/cli

      - name: Add iOS platform (if not exists)
        run: |
          cd ui/solid
          if [ ! -d "ios" ]; then
            npx cap add ios
          fi

      - name: Sync Capacitor
        run: |
          cd ui/solid
          npx cap sync ios

      - name: Extract version from tag
        id: version
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          # Convert version to build number (e.g., 1.0.1 -> 101)
          BUILD_NUMBER=$(echo $VERSION | awk -F. '{printf "%d%02d%02d", $1, $2, $3}')
          echo "build_number=$BUILD_NUMBER" >> $GITHUB_OUTPUT

      - name: Install CocoaPods
        run: |
          sudo gem install cocoapods
          cd ui/solid/ios/App
          pod install

      - name: Setup Apple Certificate
        if: env.APPLE_CERTIFICATE_BASE64 != ''
        env:
          APPLE_CERTIFICATE_BASE64: ${{ secrets.APPLE_CERTIFICATE_BASE64 }}
          APPLE_CERTIFICATE_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
          KEYCHAIN_PASSWORD: ${{ secrets.KEYCHAIN_PASSWORD || 'password' }}
        run: |
          # Create variables
          CERTIFICATE_PATH=$RUNNER_TEMP/build_certificate.p12
          KEYCHAIN_PATH=$RUNNER_TEMP/app-signing.keychain-db

          # Decode certificate
          echo "$APPLE_CERTIFICATE_BASE64" | base64 --decode > $CERTIFICATE_PATH

          # Create temporary keychain
          security create-keychain -p "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH
          security set-keychain-settings -lut 21600 $KEYCHAIN_PATH
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH

          # Import certificate
          security import $CERTIFICATE_PATH -P "$APPLE_CERTIFICATE_PASSWORD" -A -t cert -f pkcs12 -k $KEYCHAIN_PATH
          security list-keychain -d user -s $KEYCHAIN_PATH

      - name: Setup Provisioning Profile
        if: env.APPLE_PROVISIONING_PROFILE_BASE64 != ''
        env:
          APPLE_PROVISIONING_PROFILE_BASE64: ${{ secrets.APPLE_PROVISIONING_PROFILE_BASE64 }}
        run: |
          mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
          echo "$APPLE_PROVISIONING_PROFILE_BASE64" | base64 --decode > ~/Library/MobileDevice/Provisioning\ Profiles/build_profile.mobileprovision

      - name: Update version in Info.plist
        run: |
          cd ui/solid/ios/App/App
          /usr/libexec/PlistBuddy -c "Set :CFBundleShortVersionString ${{ steps.version.outputs.version }}" Info.plist
          /usr/libexec/PlistBuddy -c "Set :CFBundleVersion ${{ steps.version.outputs.build_number }}" Info.plist

      - name: Build iOS Archive
        run: |
          cd ui/solid/ios/App
          xcodebuild clean archive \
            -workspace App.xcworkspace \
            -scheme App \
            -configuration Release \
            -archivePath $RUNNER_TEMP/App.xcarchive \
            -allowProvisioningUpdates \
            CODE_SIGN_IDENTITY="Apple Distribution" \
            CODE_SIGN_STYLE="Manual" \
            PROVISIONING_PROFILE_SPECIFIER="build_profile"

      - name: Export IPA
        run: |
          cd ui/solid/ios/App
          xcodebuild -exportArchive \
            -archivePath $RUNNER_TEMP/App.xcarchive \
            -exportPath $RUNNER_TEMP/ipa \
            -exportOptionsPlist <(cat <<EOF
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
            <key>method</key>
            <string>app-store</string>
            <key>teamID</key>
            <string>${{ secrets.APPLE_TEAM_ID }}</string>
          </dict>
          </plist>
          EOF
          )

      - name: Upload IPA artifact
        uses: actions/upload-artifact@v4
        with:
          name: ios-ipa
          path: ${{ runner.temp }}/ipa/*.ipa
          retention-days: 30

      - name: Upload to App Store Connect
        if: env.APPLE_ID != '' && env.APPLE_APP_SPECIFIC_PASSWORD != ''
        uses: apple-actions/upload-testflight-build@v1
        with:
          app-path: ${{ runner.temp }}/ipa/*.ipa
          issuer-id: ${{ secrets.APPLE_ISSUER_ID }}
          api-key-id: ${{ secrets.APPLE_API_KEY_ID }}
          api-private-key: ${{ secrets.APPLE_API_PRIVATE_KEY }}
        env:
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_APP_SPECIFIC_PASSWORD: ${{ secrets.APPLE_APP_SPECIFIC_PASSWORD }}

      - name: Submit to App Store (Optional)
        if: env.APPLE_ID != '' && env.APPLE_APP_SPECIFIC_PASSWORD != '' && env.AUTO_SUBMIT == 'true'
        run: |
          # This step requires additional setup with App Store Connect API
          # For now, manual submission via App Store Connect is recommended
          echo "Build uploaded. Please submit manually via App Store Connect."

